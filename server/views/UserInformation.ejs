<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Profile</title>
    <script src="/js/jquery.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
        integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    
</head>

<body style="background-color: #f0e9d3">
    <% include fragment/header_user %>
    <div class="divtotal" style="background-color: #fff">
        <div class="container">
            <div class="row my-2">
                <div class="col-lg-8 order-lg-2">
                    <div id="message"></div>
                    <ul class="nav nav-tabs">
                        <li class="nav-item tab">
                            <a href="" data-target="#profile" data-toggle="tab" class="nav-link active"
                                style="color: #343a40; background-color:#fff">Hồ sơ cá nhân</a>
                        </li>
                        <li class="nav-item tab">
                            <a href="" data-target="#messagesTab" data-toggle="tab" class="nav-link"
                                style="color: #343a40">Thông báo</a>
                        </li>
                        <li class="nav-item tab">
                            <a href="" data-target="#edit" data-toggle="tab" class="nav-link"
                                style="color: #343a40">Chỉnh sửa thông tin</a>
                        </li>
                        <li class="nav-item tab">
                            <a href="" data-target="#passwordTab" data-toggle="tab" class="nav-link"
                                style="color: #343a40">Đổi mật khẩu</a>
                        </li>
                    </ul>
                    <div class="tab-content py-4">
                        <div class="tab-pane active" id="profile">
                            <h5 class="mb-3" id='_info_username'></h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Vai trò</h6>
                                    <p id='_info_role'></p>
                                    <h6>Email</h6>
                                    <p id='_info_email'></p>
                                    <h6>Ngày sinh</h6>
                                    <p id='_info_birth'></p>
                                </div>
                                <div class="col-md-6">
                                    <h6 id='_info_favCat'>Chuyên mục quan tâm</h6>
                                    <hr>
                                    <span class="badge badge-primary" id='_info_likes'></span>
                                    <span class="badge badge-success" id='_info_comments'></span>
                                    <span class="badge badge-danger" id='_info_share'></span>
                                </div>
                                <div class="col-md-12">
                                    <h5 class="mt-2"><span class="fa fa-clock-o ion-clock float-right"></span>Hoạt động
                                        gần đây</h5>
                                    <table class="table table-sm table-hover table-striped">
                                        <tbody id='_info_activity'>
                                            
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <!--/row-->
                        </div>
                        <div class="tab-pane" id="messagesTab">
                            
                            <table class="table table-hover table-striped">
                                <tbody id='_info_ntf'>
                                    
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane" id="edit">
                            <form id="updateForm" role="form" action="information" method="POST">
                               
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label">Họ và Tên</label>
                                    <div class="col-lg-9">
                                        <input id='_update_username' name="username" class="form-control" type="text" value="">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label">Email</label>
                                    <div class="col-lg-9">
                                        <input  id='_update_email' name="email" class="form-control" type="email" value="">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label">Ngày sinh</label>
                                    <div class="col-lg-9">
                                        <input  id='_update_birth' name="birthday" class="form-control" type="date"
                                            value="">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label">Địa chỉ</label>
                                    <div class="col-lg-9">
                                        <input id='_update_address_street' name="address_street" class="form-control" type="text"
                                            value="" placeholder="Đường">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label"></label>
                                    <div class="col-lg-3">
                                        <input id='_update_address_ward' name="address_ward" class="form-control" type="text"
                                            value="" placeholder="Phường">
                                    </div>
                                    <div class="col-lg-3">
                                        <input id='_update_address_district'  name="address_district" class="form-control" type="text"
                                            value="" placeholder="Quận">
                                    </div>
                                    <div class="col-lg-3">
                                        <input id='_update_address_city' name="address_city" class="form-control" type="text"
                                            value="" placeholder="Thành phố">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label"></label>
                                    <div class="col-lg-9">
                                        <input type="reset" class="btn btn-secondary" value="Cancel">
                                        <input type="submit" class="btn btn-primary" value="Save Changes">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane" id="passwordTab">
                            <form id="updatePwdForm" role="form">
                               
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label">Mật khẩu cũ</label>
                                    <div class="col-lg-9">
                                        <input name="oldPassword" id="oldPassword" class="form-control" type="password" value="">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label">Mật khẩu</label>
                                    <div class="col-lg-9">
                                        <input name="newPassword" id="newPassword" class="form-control" type="password" value="">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-lg-3 col-form-label form-control-label">Xác nhận mật khẩu</label>
                                    <div class="col-lg-9">
                                        <input name="confirmPassword" id="confirmPassword" class="form-control" type="password" value="">
                                    </div>
                                </div>
                                <div class="form-group row">
                                        <label class="col-lg-3 col-form-label form-control-label"></label>
                                        <div class="col-lg-9">
                                            <input type="submit" class="btn btn-primary" value="Xác nhận">
                                        </div>
                                    </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 order-lg-1 text-center">
                    <img id="avatarPreview" src="/images/user-ava.jpg" class="mx-auto img-fluid img-circle d-block"
                        alt="avatar" style="width:180px; margin-bottom:20px">
                    <h6 class="mt-2">Upload a different photo</h6>
                    <label class="custom-file">
                        <input id="inputAvatar" type="file" id="file" aria-label="File browser"
                            accept=".jpg, .jpeg, .png">
                        <span class="file-custom"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>
    <% include fragment/footer %>
    <script src="/js/popper.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
    <script type="text/javascript">
        var baseHTMLmsg = `<div class="alert alert-_msgtype alert-dismissible" id="alert_success" style="margin-top: 10px;">
<button type="button" class="close" data-dismiss="alert">&times;</button>
<strong><i class="fas fa-check"></i>_msgcontent</strong>
</div>`;

        $(document).ready(function () {
            updateDocument();
            $("#updatePwdForm").on('input', function () {
                newPassword.setCustomValidity(newPassword.value != confirmPassword.value ? "Mật khẩu không khớp." : "");
            })
            $("#newPassword").tooltip({ 'trigger': 'focus', 'title': 'Mật khẩu phải chứa chữ, số và tối thiểu 6 ký tự' });

            $("#inputAvatar").change(function () {
                var curFiles = this.files;
                var token = Cookies.get('token');
                if (!token) {
                    var inforUrl = location.protocol + '//' + window.location.host + '/';
                    document.location.replace(inforUrl);
                }

                var fd = new FormData() ;
                fd.append("image", curFiles[0])
                console.log(fd.toString());
                $.ajax({
                    url: '/api/user/avatar?token=' + token + "&audience=" + navigator.userAgent,
                    type: 'POST',
                    data: fd  ,
                    contentType: false,
                    processData: false,
                    success: function (response) {
                        $("#avatarPreview").attr("src", window.URL.createObjectURL(curFiles[0]));
                        var msg = baseHTMLmsg.replace('_msgtype', 'success')
                            .replace('_msgcontent', response);
                        $("#message").html(msg);
                    },
                    error: (err) => {
                        console.log(err);
                        var msg = baseHTMLmsg.replace('_msgtype', 'danger')
                            .replace('_msgcontent', err.responseText);
                        $("#message").html(msg);
                    }
                });
            });
        });

        
        function updateDocument() {
            var token =  Cookies.get('token');
            if (!token) {
                var inforUrl = location.protocol + '//' + window.location.host  + '/';
                document.location.replace(inforUrl);
            }
            var fd = new FormData();
            fd.append('token', token);
            fd.append('audience', navigator.userAgent);

            $.ajax({
                url: '/api/user/information' ,
                type: 'GET',
                data: {token: token, audience: navigator.userAgent},
                // contentType: false,
                // processData: false,
                success: function (response) {
                    $("#_info_username").text(response.username);
                    $("#_update_username").val(response.username);
                    $("#_info_role").text(response.role);
                    $("#_info_email").text(response.email);
                    $("#_update_email").val(response.email);
                    $("#_info_birth").text(response.birthday);
                    $("#_update_birth").val(response.birthday);
                    $("#_update_address_street").val(response.address.street);
                    $("#_update_address_ward").val(response.address.ward);
                    $("#_update_address_district").val(response.address.district);
                    $("#_update_address_city").val(response.address.city);
                    $("#avatarPreview").attr('src', response.avatar);

                    response.favCat.forEach(element => {
                        var newEl = $("<a class='badge badge-dark badge-pill'></a>").text(element.name);
                        newEl.attr('href', element.url);
                        newEl.insertBefore('#_info_favCat hr')
                    });

                    $("#_info_likes").append(`<i class="fas fa-thumbs-up"> ${response.likes}  Likes`);
                    $("#_info_comments").append(`<i class="fas fa-comments"> ${response.comments}  Comments`);
                    $("#_info_share").append(`<i class="fas fa-share-alt-square"> ${response.shares}  Shares`);

                    response.activities.forEach(function (activity) {
                        var tr = document.createElement('tr');
                        var td = document.createElement('td');
                        td.textContent = `<strong>Bạn</strong> ${activity.action} <a class="post-title"> ${activity.post}</a>`
                        tr.appendChild(td);
                        $('#_info_activity').append(tr);
                    })

                    var messageTab = document.getElementById('messagesTab');
                    response.notifications.forEach(function (notify) {
                        if (notify.alert) {
                            $(`<div class="alert ${notify.alert} alert-dismissable">
                                <a class="panel-close close" data-dismiss="alert">×</a>${notify.msg}</div>`).insertBefore('#messagesTab table');
                        }else {
                            $('#messagesTab table tbody').append(`<tr>
                                        <td>
                                            <span class="float-right font-weight-bold">3 giờ
                                                trước</span>${notify.msg}
                                        </td>
                                    </tr>`);
                        }
                    })
                },
                error: function (err) {
                    console.log(err);
                    var msg = baseHTMLmsg.replace('_msgtype', 'danger')
                        .replace('_msgcontent', err.responseText);
                    console.log(err);
                    $("#message").html(msg);
                }
            });

        }

        $('#updateForm').on('submit',(event) => {
            var token =  Cookies.get('token');
            if (!token) {
                var inforUrl = location.protocol + '//' + window.location.host  + '/';
                document.location.replace(inforUrl);
            }
            event.preventDefault();
            $.ajax({
                url: '/api/user/information',
                type: 'POST',
                data: $('#updateForm').serialize() +'&token=' + token + "&audience=" + navigator.userAgent,
                success: function (response) {
                    console.log(response);
                    var msg = baseHTMLmsg.replace('_msgtype', 'success')
                        .replace('_msgcontent', response);
                    $("#message").html(msg);
                },
                error: function (err) {
                    var msg = baseHTMLmsg.replace('_msgtype', 'danger')
                        .replace('_msgcontent', err.responseText);
                    console.log(err);
                    $("#message").html(msg);
                }
            });
        })

        $('#updatePwdForm').on('submit', (event) => {
            event.preventDefault();
            var token =  Cookies.get('token');
            if (!token) {
                var inforUrl = location.protocol + '//' + window.location.host  + '/';
                document.location.replace(inforUrl);
            }
            event.preventDefault();
            $.ajax({
                url: '/api/user/resetpassword',
                type: 'POST',
                data: $('#updatePwdForm').serialize() +'&token=' + token + "&audience=" + navigator.userAgent,
                success: function (response) {
                    console.log(response);
                    var msg = baseHTMLmsg.replace('_msgtype', 'success')
                        .replace('_msgcontent', response);
                    $("#message").html(msg);
                },
                error: function (err) {
                    var msg = baseHTMLmsg.replace('_msgtype', 'danger')
                        .replace('_msgcontent', err.responseText);
                    console.log(err);
                    $("#message").html(msg);
                }
            });
        })
    </script>
</body>

</html>
